<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Securely share encrypted messages with password protection">
    <title>Secret Share | Devtools</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/theme.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="../assets/favicon.ico" type="image/x-icon">
</head>
<body>
    <header>
        <div class="container">
            <div class="logo">
                <a href="../index.html">Devtools</a>
            </div>
            <nav>
                <ul>
                    <li><a href="../index.html">Home</a></li>
                    <li><a href="https://github.com/irfansofyana/devtools" target="_blank">GitHub</a></li>
                </ul>
            </nav>
            <div class="theme-toggle">
                <button id="theme-toggle-btn" aria-label="Toggle dark/light theme">
                    <span class="icon light-icon">‚òÄÔ∏è</span>
                    <span class="icon dark-icon">üåô</span>
                </button>
            </div>
        </div>
    </header>

    <main>
        <section class="tool-container">
            <div class="container">
                <div class="tool-header">
                    <h1>Secret Share</h1>
                </div>
                <div class="tool-description">
                    <p>Securely share encrypted messages with password protection. Perfect for sharing API keys, credentials, or sensitive code snippets.</p>
                </div>

                <div class="tool-content">
                    <div class="error-message hidden" id="error-message"></div>
                    <div class="success-message hidden" id="success-message"></div>
                    
                    <!-- Create Secret Mode -->
                    <div id="create-mode" class="mode-container">
                        <h3>Create Encrypted Secret</h3>
                        
                        <div class="input-group">
                            <label for="secret-text">Secret Message:</label>
                            <textarea id="secret-text" placeholder="Enter your secret message, API key, or sensitive text..." aria-label="Secret message" rows="6"></textarea>
                            <div class="char-counter">
                                <span id="char-count">0</span> / 10000 characters
                            </div>
                        </div>

                        <div class="input-group">
                            <label for="secret-password">Password:</label>
                            <input type="password" id="secret-password" placeholder="Enter a strong password..." aria-label="Password">
                            <div class="password-strength">
                                <div class="strength-meter">
                                    <div class="strength-bar" id="password-strength-bar"></div>
                                </div>
                                <div class="strength-label" id="password-strength-label">Enter password</div>
                            </div>
                        </div>

                        <div class="options-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="burn-after-reading">
                                Burn after reading (URL becomes invalid after first view)
                            </label>
                        </div>
                        
                        <div class="text-center">
                            <button class="primary" id="create-secret-btn">Create Secret Link</button>
                        </div>

                        <div class="result-container hidden" id="create-result">
                            <h3>Secret Link Created</h3>
                            <div class="link-display">
                                <input type="text" id="secret-url" readonly aria-label="Secret URL">
                                <button class="secondary" id="copy-url-btn">Copy Link</button>
                            </div>
                            <div class="warning-box">
                                <strong>‚ö†Ô∏è Important:</strong>
                                <ul>
                                    <li>Share this link securely (separate from the password)</li>
                                    <li>The password is required to decrypt the message</li>
                                    <li>Data is encrypted client-side and stored in the URL</li>
                                    <li>No data is sent to any server</li>
                                </ul>
                            </div>
                            <button class="secondary" id="create-another-btn">Create Another Secret</button>
                        </div>
                    </div>

                    <!-- View Secret Mode -->
                    <div id="view-mode" class="mode-container hidden">
                        <h3>View Encrypted Secret</h3>
                        
                        <div class="input-group">
                            <label for="decrypt-password">Enter Password:</label>
                            <input type="password" id="decrypt-password" placeholder="Enter the password to decrypt..." aria-label="Decryption password">
                        </div>
                        
                        <div class="text-center">
                            <button class="primary" id="decrypt-btn">Decrypt Secret</button>
                        </div>

                        <div class="result-container hidden" id="decrypt-result">
                            <h3>Decrypted Secret</h3>
                            <div class="secret-display">
                                <textarea id="decrypted-text" readonly rows="6"></textarea>
                            </div>
                            <div class="secret-controls">
                                <button class="secondary" id="copy-secret-btn">
                                    <i class="fas fa-copy"></i>
                                    <span class="button-text">Copy Secret</span>
                                </button>
                                <button class="secondary" id="download-secret-btn">
                                    <i class="fas fa-download"></i>
                                    <span class="button-text">Download as File</span>
                                </button>
                            </div>
                            <div class="warning-box">
                                <strong>üîì Secret revealed!</strong> Make sure you're in a secure environment.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            <p>&copy; <span id="current-year">2025</span> Devtools. All rights reserved.</p>
            <p>
                <a href="https://github.com/irfansofyana/devtools" target="_blank">GitHub</a> |
                <a href="https://github.com/irfansofyana/devtools/issues" target="_blank">Report Issues</a>
            </p>
        </div>
    </footer>

    <script src="../js/theme.js"></script>
    <script src="../js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM elements
            const secretText = document.getElementById('secret-text');
            const secretPassword = document.getElementById('secret-password');
            const createSecretBtn = document.getElementById('create-secret-btn');
            const createResult = document.getElementById('create-result');
            const secretUrl = document.getElementById('secret-url');
            const copyUrlBtn = document.getElementById('copy-url-btn');
            const createAnotherBtn = document.getElementById('create-another-btn');
            const burnAfterReading = document.getElementById('burn-after-reading');
            const charCount = document.getElementById('char-count');
            
            const decryptPassword = document.getElementById('decrypt-password');
            const decryptBtn = document.getElementById('decrypt-btn');
            const decryptResult = document.getElementById('decrypt-result');
            const decryptedText = document.getElementById('decrypted-text');
            const copySecretBtn = document.getElementById('copy-secret-btn');
            const downloadSecretBtn = document.getElementById('download-secret-btn');
            
            const createMode = document.getElementById('create-mode');
            const viewMode = document.getElementById('view-mode');
            const errorMessage = document.getElementById('error-message');
            const successMessage = document.getElementById('success-message');
            const passwordStrengthBar = document.getElementById('password-strength-bar');
            const passwordStrengthLabel = document.getElementById('password-strength-label');
            
            // Show error message
            function showError(message) {
                errorMessage.textContent = message;
                errorMessage.classList.remove('hidden');
                successMessage.classList.add('hidden');
                setTimeout(() => {
                    errorMessage.classList.add('hidden');
                }, 5000);
            }
            
            // Show success message
            function showSuccess(message) {
                successMessage.textContent = message;
                successMessage.classList.remove('hidden');
                errorMessage.classList.add('hidden');
                setTimeout(() => {
                    successMessage.classList.add('hidden');
                }, 3000);
            }
            
            // Update character counter
            secretText.addEventListener('input', () => {
                const count = secretText.value.length;
                charCount.textContent = count;
                if (count > 10000) {
                    charCount.style.color = 'var(--color-error)';
                } else {
                    charCount.style.color = 'var(--color-text-secondary)';
                }
            });
            
            // Password strength checker
            secretPassword.addEventListener('input', () => {
                const password = secretPassword.value;
                const strength = calculatePasswordStrength(password);
                updatePasswordStrength(strength);
            });
            
            function calculatePasswordStrength(password) {
                if (!password) return 0;
                
                let score = 0;
                const length = password.length;
                
                // Length score
                score += Math.min(25, length * 2);
                
                // Character variety
                if (/[a-z]/.test(password)) score += 15;
                if (/[A-Z]/.test(password)) score += 15;
                if (/[0-9]/.test(password)) score += 15;
                if (/[^A-Za-z0-9]/.test(password)) score += 15;
                
                // Length bonus
                if (length >= 12) score += 15;
                
                return Math.min(100, score);
            }
            
            function updatePasswordStrength(strength) {
                passwordStrengthBar.style.width = `${strength}%`;
                
                if (strength === 0) {
                    passwordStrengthBar.style.backgroundColor = '#ccc';
                    passwordStrengthLabel.textContent = 'Enter password';
                } else if (strength < 40) {
                    passwordStrengthBar.style.backgroundColor = '#ff4d4d';
                    passwordStrengthLabel.textContent = 'Weak';
                } else if (strength < 70) {
                    passwordStrengthBar.style.backgroundColor = '#ffaa00';
                    passwordStrengthLabel.textContent = 'Medium';
                } else {
                    passwordStrengthBar.style.backgroundColor = '#00cc44';
                    passwordStrengthLabel.textContent = 'Strong';
                }
            }
            
            // Encryption functions
            async function encryptMessage(message, password) {
                const encoder = new TextEncoder();
                const data = encoder.encode(message);
                
                // Derive key from password
                const passwordKey = await crypto.subtle.importKey(
                    'raw',
                    encoder.encode(password),
                    'PBKDF2',
                    false,
                    ['deriveKey']
                );
                
                const salt = crypto.getRandomValues(new Uint8Array(16));
                const key = await crypto.subtle.deriveKey(
                    {
                        name: 'PBKDF2',
                        salt: salt,
                        iterations: 100000,
                        hash: 'SHA-256'
                    },
                    passwordKey,
                    { name: 'AES-GCM', length: 256 },
                    false,
                    ['encrypt']
                );
                
                const iv = crypto.getRandomValues(new Uint8Array(12));
                const encrypted = await crypto.subtle.encrypt(
                    { name: 'AES-GCM', iv: iv },
                    key,
                    data
                );
                
                // Combine salt, iv, and encrypted data
                const combined = new Uint8Array(salt.length + iv.length + encrypted.byteLength);
                combined.set(salt, 0);
                combined.set(iv, salt.length);
                combined.set(new Uint8Array(encrypted), salt.length + iv.length);
                
                return btoa(String.fromCharCode(...combined));
            }
            
            async function decryptMessage(encryptedData, password) {
                const encoder = new TextEncoder();
                const decoder = new TextDecoder();
                
                // Decode base64
                const combined = new Uint8Array(
                    atob(encryptedData).split('').map(char => char.charCodeAt(0))
                );
                
                // Extract salt, iv, and encrypted data
                const salt = combined.slice(0, 16);
                const iv = combined.slice(16, 28);
                const encrypted = combined.slice(28);
                
                // Derive key from password
                const passwordKey = await crypto.subtle.importKey(
                    'raw',
                    encoder.encode(password),
                    'PBKDF2',
                    false,
                    ['deriveKey']
                );
                
                const key = await crypto.subtle.deriveKey(
                    {
                        name: 'PBKDF2',
                        salt: salt,
                        iterations: 100000,
                        hash: 'SHA-256'
                    },
                    passwordKey,
                    { name: 'AES-GCM', length: 256 },
                    false,
                    ['decrypt']
                );
                
                const decrypted = await crypto.subtle.decrypt(
                    { name: 'AES-GCM', iv: iv },
                    key,
                    encrypted
                );
                
                return decoder.decode(decrypted);
            }
            
            // Create secret
            async function createSecret() {
                const message = secretText.value.trim();
                const password = secretPassword.value;
                
                if (!message) {
                    showError('Please enter a secret message');
                    return;
                }
                
                if (!password) {
                    showError('Please enter a password');
                    return;
                }
                
                if (message.length > 10000) {
                    showError('Message is too long (maximum 10,000 characters)');
                    return;
                }
                
                if (calculatePasswordStrength(password) < 40) {
                    showError('Please use a stronger password for better security');
                    return;
                }
                
                try {
                    createSecretBtn.disabled = true;
                    createSecretBtn.textContent = 'Encrypting...';
                    
                    const encryptedData = await encryptMessage(message, password);
                    const metadata = {
                        v: 1, // version
                        burn: burnAfterReading.checked,
                        ts: Date.now()
                    };
                    
                    const payload = {
                        data: encryptedData,
                        meta: metadata
                    };
                    
                    const encodedPayload = btoa(JSON.stringify(payload));
                    const secretUrlValue = `${window.location.origin}${window.location.pathname}#${encodedPayload}`;
                    
                    secretUrl.value = secretUrlValue;
                    createResult.classList.remove('hidden');
                    
                    showSuccess('Secret link created successfully!');
                } catch (error) {
                    showError(`Encryption failed: ${error.message}`);
                } finally {
                    createSecretBtn.disabled = false;
                    createSecretBtn.textContent = 'Create Secret Link';
                }
            }
            
            // Decrypt secret
            async function decryptSecret() {
                const password = decryptPassword.value;
                
                if (!password) {
                    showError('Please enter the password');
                    return;
                }
                
                try {
                    decryptBtn.disabled = true;
                    decryptBtn.textContent = 'Decrypting...';
                    
                    const hash = window.location.hash.substring(1);
                    if (!hash) {
                        showError('No encrypted data found in URL');
                        return;
                    }
                    
                    const payload = JSON.parse(atob(hash));
                    const decrypted = await decryptMessage(payload.data, password);
                    
                    decryptedText.value = decrypted;
                    decryptResult.classList.remove('hidden');
                    
                    // Handle burn after reading
                    if (payload.meta && payload.meta.burn) {
                        window.location.hash = '';
                        showSuccess('Secret decrypted! (Link has been burned)');
                    } else {
                        showSuccess('Secret decrypted successfully!');
                    }
                } catch (error) {
                    showError('Decryption failed. Please check your password.');
                } finally {
                    decryptBtn.disabled = false;
                    decryptBtn.textContent = 'Decrypt Secret';
                }
            }
            
            // Copy functions
            function copyUrl() {
                secretUrl.select();
                document.execCommand('copy');
                showSuccess('Secret link copied to clipboard!');
            }
            
            function copySecret() {
                decryptedText.select();
                document.execCommand('copy');
                
                // Visual feedback on button
                const icon = copySecretBtn.querySelector('i');
                const text = copySecretBtn.querySelector('.button-text');
                const originalIcon = icon.className;
                const originalText = text.textContent;
                
                copySecretBtn.classList.add('copied');
                icon.className = 'fas fa-check';
                text.textContent = 'Copied!';
                
                setTimeout(() => {
                    copySecretBtn.classList.remove('copied');
                    icon.className = originalIcon;
                    text.textContent = originalText;
                }, 2000);
                
                showSuccess('Secret copied to clipboard!');
            }
            
            function downloadSecret() {
                const content = decryptedText.value;
                const blob = new Blob([content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                
                // Visual feedback on button
                const icon = downloadSecretBtn.querySelector('i');
                const text = downloadSecretBtn.querySelector('.button-text');
                const originalIcon = icon.className;
                const originalText = text.textContent;
                
                downloadSecretBtn.classList.add('copied');
                icon.className = 'fas fa-check';
                text.textContent = 'Downloaded!';
                
                // Create download
                const a = document.createElement('a');
                a.href = url;
                a.download = `secret-${Date.now()}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                setTimeout(() => {
                    downloadSecretBtn.classList.remove('copied');
                    icon.className = originalIcon;
                    text.textContent = originalText;
                }, 2000);
                
                showSuccess('Secret downloaded as file!');
            }
            
            function createAnother() {
                secretText.value = '';
                secretPassword.value = '';
                burnAfterReading.checked = false;
                createResult.classList.add('hidden');
                charCount.textContent = '0';
                updatePasswordStrength(0);
            }
            
            // Check if we're in view mode (has hash)
            function checkMode() {
                if (window.location.hash) {
                    createMode.classList.add('hidden');
                    viewMode.classList.remove('hidden');
                } else {
                    createMode.classList.remove('hidden');
                    viewMode.classList.add('hidden');
                }
            }
            
            // Event listeners
            createSecretBtn.addEventListener('click', createSecret);
            decryptBtn.addEventListener('click', decryptSecret);
            copyUrlBtn.addEventListener('click', copyUrl);
            copySecretBtn.addEventListener('click', copySecret);
            downloadSecretBtn.addEventListener('click', downloadSecret);
            createAnotherBtn.addEventListener('click', createAnother);
            
            // Allow Enter key to trigger actions
            secretPassword.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') createSecret();
            });
            
            decryptPassword.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') decryptSecret();
            });
            
            // Initialize
            checkMode();
            window.addEventListener('hashchange', checkMode);
            
            // Set current year in footer
            document.getElementById('current-year').textContent = new Date().getFullYear();
        });
    </script>
    <style>
        .mode-container {
            margin-bottom: 2rem;
        }
        
        .char-counter {
            text-align: right;
            font-size: 0.9em;
            color: var(--color-text-secondary);
            margin-top: 5px;
        }
        
        .password-strength {
            margin-top: 8px;
        }
        
        .strength-meter {
            height: 6px;
            background-color: var(--color-bg-secondary);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 5px;
        }
        
        .strength-bar {
            height: 100%;
            width: 0;
            background-color: #ccc;
            transition: width 0.3s, background-color 0.3s;
        }
        
        .strength-label {
            font-size: 0.9em;
            color: var(--color-text-secondary);
        }
        
        .options-group {
            margin: 1rem 0;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        
        .link-display {
            display: flex;
            gap: 10px;
            margin-bottom: 1rem;
        }
        
        .secret-display {
            margin-bottom: 1rem;
        }
        
        .link-display input, .secret-display textarea {
            width: 100%;
            font-family: var(--font-mono);
        }
        
        .secret-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 1rem;
            justify-content: flex-start;
        }
        
        .secret-controls button {
            min-width: 110px;
            padding: 8px 12px;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.2s ease;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .secret-controls button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .secret-controls button:active {
            transform: translateY(0);
        }
        
        .secret-controls button.copied {
            background: var(--success-bg) !important;
            color: var(--success-text) !important;
            border-color: var(--success-text) !important;
        }
        
        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 1rem;
            margin: 1rem 0;
            color: #856404;
        }
        
        .warning-box ul {
            margin: 0.5rem 0 0 0;
            padding-left: 1.5rem;
        }
        
        .warning-box li {
            margin-bottom: 0.25rem;
        }
        
        .success-message {
            background: var(--success-bg);
            border: 1px solid var(--success-text);
            color: var(--success-text);
            padding: 0.75rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
        
        @media (max-width: 768px) {
            .link-display {
                flex-direction: column;
            }
            
            .secret-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .secret-controls button {
                min-width: auto;
                width: 100%;
                margin-bottom: 8px;
            }
            
            .secret-controls button:last-child {
                margin-bottom: 0;
            }
        }
    </style>
</body>
</html>